# Decision Log

| Date | Decision | Rationale |
|------|----------|-----------|
| 2025-12-03 | Use native TTS queue-empty event and RN-driven chapter continuation; include `paragraphIndex` in `speak()` and use `utterance_<index>` IDs | WebView JS is suspended when the device sleeps/when screen is off; relying on WebView for chapter-transition and queue refills breaks background TTS. Native detection of an empty queue allows RN to prefetch and continue playback without JS execution. |
| 2025-12-03 | Extract paragraphs from HTML in React Native (htmlParagraphExtractor.ts) instead of relying on WebView DOM | When navigating to next chapter during background TTS (screen off), WebView doesn't execute JS. By extracting paragraphs directly from HTML in RN using regex-based parsing, we can start TTS batch playback without waiting for WebView initialization. |
| 2025-12-03 | Add backgroundTTSPendingRef flag to coordinate chapter transitions | When onQueueEmpty fires and we navigate to next chapter, we set this flag. When the new chapter's HTML loads (effect on chapter.id + html), if flag is set, we start TTS directly from RN. This decouples TTS continuation from WebView lifecycle. |
| 2025-12-03 | Reset currentParagraphIndexRef to 0 on chapter change | Prevents stale paragraph indices from old chapter being used for highlighting in new chapter. Combined with bounds checking in core.js highlightParagraph(), this prevents "index out of bounds" errors during chapter transitions. |
| 2025-12-03 | Include chapter ID in TTS utterance IDs (chapter_${chapterId}_utterance_${index}) to prevent stale event processing during chapter transitions | When navigating to a new chapter during background TTS playback, events from the old chapter's utterances were still firing and causing paragraph sync issues (jumping from single digit paragraphs to hundreds). By including chapter ID in utterance IDs and validating in event handlers, we can ignore stale events from previous chapters. |
| 2025-12-03 | Track foreground service state (isServiceForeground) in TTSForegroundService.kt to prevent Android 12+ background start restriction | Android 12+ (API 31+) introduced ForegroundServiceStartNotAllowedException which prevents starting foreground services from background. When transitioning between chapters during background TTS playback, calling stop() releases the foreground state, then speakBatch() fails to restart it. By tracking whether the service is already foreground and only calling startForeground() when needed, we avoid this error. |
| 2025-12-03 | Don't call TTSHighlight.stop() before speakBatch() during background chapter transitions | In background mode, calling stop() releases the foreground service state which cannot be restarted from background on Android 12+. Instead, just call speakBatch() directly which internally uses QUEUE_FLUSH on the first item to clear the old queue while maintaining the foreground service state. |
| 2025-12-03 | Use addToBatch() instead of speakBatch() for TTS queue events to prevent QUEUE_FLUSH from clearing the already-playing first paragraph | When JS sends both 'speak' and 'tts-queue' events, speakBatch() uses QUEUE_FLUSH for the first item which clears the utterance queued by speak(). Using addToBatch() with QUEUE_ADD mode preserves the currently playing utterance. |
| 2025-12-03 | Add ttsScreenWakeSyncPending flag to block scroll operations during screen wake sync | When screen wakes during background TTS after chapter transition, calculatePages() and ResizeObserver could trigger scroll to saved progress before RN's screen wake sync handler runs. The blocking flag prevents race conditions. |
| 2025-12-04 | Track WebView sync state with isWebViewSyncedRef to prevent JS injection into wrong chapter context during background TTS playback | When TTS transitions to next chapter during background playback (screen off), the WebView doesn't reload with new chapter HTML - it still has the old chapter. Attempting to inject highlightParagraph/updateState JS into this stale WebView causes "stale chapter" rejections in core.js because the chapter IDs don't match. By tracking if WebView is synced (set false on background nav, true on onLoadEnd), we can skip WebView injections entirely during background mode and let TTS continue without UI updates. When screen wakes, WebView will reload and sync properly. |
| 2025-12-04 | Fix stale closure bug in onQueueEmpty handler by using refs (nextChapterRef, navigateChapterRef) instead of direct closure values | The onQueueEmpty handler was created inside a useEffect with empty dependency array [], causing nextChapter and navigateChapter to be captured at mount time. After the first chapter transition, these closure values became stale (still pointing to chapter 6097) while React state updated correctly to 6098. By using refs that are synced via a separate useEffect, the handler always reads the current values. |
| 2025-12-04 | Initialize paragraph indexes from DB/MMKV/ttsState instead of resetting to 0 on chapter change | Previous code unconditionally reset `currentParagraphIndexRef` and `latestParagraphIndexRef` to 0 on every chapter change. This caused race conditions: when screen wakes during background TTS, the index was already reset to 0 before native TTS events could update it. Now we compute `initialIndex = Math.max(dbIndex, mmkvIndex, ttsStateIndex)` to preserve the most recent known position. |
| 2025-12-04 | Add grace period filtering for stale/early save events during chapter transitions | WebView may emit initial "save" events with paragraph 0 on load, or delayed events from the previous chapter. Added 1-second grace period after chapter transitions that: (1) blocks saves without chapterId, (2) blocks saves where incoming index < latest known index, (3) blocks initial 0 saves when we already have positive progress. Prevents UI from jumping backward. |
| 2025-12-04 | Pause native TTS on screen wake, sync UI, then resume from correct position | Previous behavior kept TTS playing while UI synced, causing desync. New flow: (1) AppState 'active' â†’ pause native TTS immediately, (2) inject JS to scroll/highlight current paragraph, (3) after sync completes, resume TTS via speakBatch from the saved index. Ensures UI and audio are always in sync after wake. |
| 2025-12-04 | Extract TTS logic into testable utility module (ttsWakeUtils.js) | Core logic for index computation, batch building, and save filtering extracted into pure functions that can be unit tested without React Native runtime. Enables comprehensive Jest test coverage for race condition scenarios. |
| 2025-12-04 | Voice names show LOCAL/NETWORK badges instead of quality downgrading | User can distinguish between local (robotic but offline) and network (high quality but requires internet) voices to make informed choices |
| 2025-12-05 | Fix TTS screen-wake resume bug: When screen wakes during background TTS playback, STOP (not pause) the TTS engine immediately to prevent queue continuation to next chapter. Save exact chapter ID + paragraph index at wake time. On WebView reload, VERIFY the loaded chapter matches the saved wake chapter before resuming - if mismatch, do NOT auto-resume TTS. | The previous implementation only paused TTS when screen woke with WebView out-of-sync, but the TTS queue continued processing in background, advancing chapters. When WebView finally synced, it was on the wrong chapter. The fix ensures TTS state is frozen at the exact moment of wake and only resumes after verification that the correct chapter is loaded. |
| 2025-12-05 | Fix TTS bugs: 1) Increased BATCH_SIZE to 25 and REFILL_THRESHOLD to 10 to prevent premature chapter jumps 2) Added refillInProgress flag to prevent onQueueEmpty during async refill 3) Added capturedWakeParagraphIndexRef to capture paragraph index BEFORE pause 4) Added wakeTransitionInProgressRef to block stale events during wake sync | Two root causes identified: Bug A (wrong lines after wake) was caused by race condition where onSpeechStart events mutated currentParagraphIndexRef during async pause. Bug C (premature chapter jump) was caused by native queue exhausting before JS refill could complete. |
| 2025-12-07 | Cross-chapter progress and resume UI improvements: set full progress for completed chapters; mark future chapters as unread; add conflict list + selector | Resolved inconsistent states when using TTS "Start Here" and reset flows. `markChaptersBeforePositionRead` now sets `progress=100` in addition to `unread=0`. `resetFutureChaptersProgress` now sets `unread=1` in addition to `progress=0`, preventing future chapters from appearing as partially read. Added `getRecentReadingChapters()` selector and enhanced `WebViewReader` + `TTSChapterSelectionDialog` to show up to 3 conflicting active chapters and a clear Start/Resume flow. |
