# Bluetooth Headset Media Controls - Research Findings

**Mode:** review
**Date:** 12/31/2025, 8:20:32 AM

---

# Bluetooth Headset Media Controls Research

## Current Implementation Analysis

Your current implementation has **most** of what's needed for Bluetooth media controls:

| Component | Status | Location |
|-----------|--------|----------|
| `MediaSessionCompat` | ✅ Created & active | [TTSForegroundService.kt](android/app/src/main/java/com/rajarsheechatterjee/LNReader/TTSForegroundService.kt#L166) |
| `MediaSessionCallback` | ✅ Implemented | Lines 98-121 |
| `PlaybackStateCompat` with actions | ✅ Configured | Lines 171-183, 761-780 |
| Audio focus handling | ✅ Implemented | Lines 531-578 |
| `androidx.media:media` dependency | ✅ Available | [build.gradle](android/app/build.gradle#L123) v1.7.0 |
| **MediaButtonReceiver** | ❌ **Missing** | Not in manifest |
| **MEDIA_BUTTON intent filter** | ❌ **Missing** | Not on service |
| **handleIntent() call** | ❌ **Missing** | Not in onStartCommand |

## Why Bluetooth Isn't Working

Android routes media button events through `android.intent.action.MEDIA_BUTTON` intents. Without:
1. A **MediaButtonReceiver** registered in manifest
2. An **intent filter** for `MEDIA_BUTTON` on the service
3. Calling **`MediaButtonReceiver.handleIntent()`** to forward events to the MediaSession

...the system has no way to route Bluetooth headset button presses to your `MediaSessionCompat.Callback`.

## Required Changes (Keeps 5-button UI 100% intact)

### 1. Add MediaButtonReceiver to AndroidManifest.xml

```xml
<!-- Inside <application> tag, before TTSForegroundService -->
<receiver
    android:name="androidx.media.session.MediaButtonReceiver"
    android:exported="true">
    <intent-filter>
        <action android:name="android.intent.action.MEDIA_BUTTON" />
    </intent-filter>
</receiver>
```

### 2. Add intent-filter to TTSForegroundService

Update existing service declaration:
```xml
<service
    android:name=".TTSForegroundService"
    android:enabled="true"
    android:exported="false"
    android:foregroundServiceType="mediaPlayback">
    <intent-filter>
        <action android:name="android.intent.action.MEDIA_BUTTON" />
    </intent-filter>
</service>
```

### 3. Handle MediaButton intents in onStartCommand()

Add import and handle intents:
```kotlin
import androidx.media.session.MediaButtonReceiver

override fun onStartCommand(intent: Intent?, flags: Int, startId: Int): Int {
    // Handle media button intents from Bluetooth/wired headsets
    MediaButtonReceiver.handleIntent(mediaSession, intent)
    
    // ...existing switch/when statement
}
```

### 4. Set initial PlaybackState to PAUSED (not NONE)

In `onCreate()`, change:
```kotlin
.setState(PlaybackStateCompat.STATE_NONE, 0, 1.0f)
```
to:
```kotlin
.setState(PlaybackStateCompat.STATE_PAUSED, 0, 1.0f)
```

## Impact on 5-Button UI

**Zero impact.** These changes only add routing for Bluetooth events. The notification still:
- Uses `MediaStyle()` WITHOUT `.setMediaSession()` attached
- Preserves all 6 action buttons (5 + stop)
- Shows compact view with indices [1, 2, 3]

## How It Works After Fix

```
Bluetooth Headset Play Button
    ↓
System broadcasts MEDIA_BUTTON intent
    ↓
MediaButtonReceiver catches it (manifest)
    ↓
Routes to TTSForegroundService (intent-filter)
    ↓
onStartCommand() receives intent
    ↓
MediaButtonReceiver.handleIntent(mediaSession, intent)
    ↓
Triggers MediaSessionCallback.onPlay()
    ↓
ttsListener?.onMediaAction(ACTION_MEDIA_PLAY_PAUSE)
    ↓
React Native receives event → playTTS()
```

## Button Mapping

| Bluetooth Button | Maps To |
|-----------------|---------|
| Play | `MediaSessionCallback.onPlay()` → Play/Pause |
| Pause | `MediaSessionCallback.onPause()` → Play/Pause |
| Next | `MediaSessionCallback.onSkipToNext()` → Next Chapter |
| Previous | `MediaSessionCallback.onSkipToPrevious()` → Previous Chapter |
| Fast Forward | `MediaSessionCallback.onFastForward()` → Forward 5 |
| Rewind | `MediaSessionCallback.onRewind()` → Rewind 5 |

---

**Confidence: 92%** - The implementation is straightforward and well-documented in Android documentation. This is the standard pattern for adding Bluetooth media controls.

**Would you like me to implement these changes?**